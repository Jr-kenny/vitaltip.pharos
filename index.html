<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Chain Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1c1c; /* A very dark gray */
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .calculator-container {
            width: 100%;
            max-width: 20rem;
            background-color: #2c2c2c; /* A slightly lighter dark gray */
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        .btn {
            padding: 1rem 0;
            border-radius: 0.75rem;
            font-size: 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn-gray {
            background-color: #4b4b4b; /* Darker gray for buttons */
        }
        .btn-gray:hover {
            background-color: #5a5a5a;
        }
        .btn-orange {
            background-color: #ff9500; /* Orange for operation buttons */
            color: white;
        }
        .btn-orange:hover {
            background-color: #e68a00;
        }
        .btn-blue {
            background-color: #0a84ff; /* Blue for 'Connected' button */
            color: white;
            font-weight: bold;
        }
        .btn-blue:hover {
            background-color: #0073e6;
        }
        .display {
            background-color: #000000;
            color: #ffffff;
            font-size: 3rem;
            font-weight: 300;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: right;
            margin-bottom: 1rem;
            min-height: 5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-end;
            word-break: break-all;
        }
        .display-previous {
            font-size: 1.5rem;
            color: #a0a0a0;
            min-height: 2rem;
            overflow: hidden;
            white-space: nowrap;
        }
        .display-current {
            font-size: 3rem;
            color: #00e500;
            min-height: 3rem;
            overflow: hidden;
            white-space: nowrap;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="calculator-container">

        <!-- Connection Status -->
        <div class="w-full mb-4">
            <button id="connect-wallet-btn" class="w-full btn btn-blue flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span>Connect Wallet</span>
            </button>
        </div>

        <!-- Calculator Display -->
        <div class="display">
            <span id="display-previous" class="display-previous"></span>
            <span id="display-current" class="display-current">0</span>
        </div>

        <!-- Calculator Buttons Grid -->
        <div class="button-grid">
            <button class="btn btn-gray" id="clear-btn">C</button>
            <button class="btn btn-gray" id="backspace-btn">⌫</button>
            <button class="btn btn-orange" data-op="mod">%</button>
            <button class="btn btn-orange" data-op="div">÷</button>
            
            <button class="btn btn-gray" data-val="7">7</button>
            <button class="btn btn-gray" data-val="8">8</button>
            <button class="btn btn-gray" data-val="9">9</button>
            <button class="btn btn-orange" data-op="mul">×</button>
            
            <button class="btn btn-gray" data-val="4">4</button>
            <button class="btn btn-gray" data-val="5">5</button>
            <button class="btn btn-gray" data-val="6">6</button>
            <button class="btn btn-orange" data-op="sub">-</button>
            
            <button class="btn btn-gray" data-val="1">1</button>
            <button class="btn btn-gray" data-val="2">2</button>
            <button class="btn btn-gray" data-val="3">3</button>
            <button class="btn btn-orange" data-op="add">+</button>
            
            <button class="btn btn-gray col-span-2" data-val="0">0</button>
            <button class="btn btn-gray" data-val=".">.</button>
            <button class="btn btn-orange" id="calculate-btn">=</button>
        </div>

    </div>

    <!-- Ethers.js library import -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>

    <script>
        // Immediately invoked async function to encapsulate the script
        (async function() {
            // Contract details
            const CONTRACT_ADDRESS = '0x0640761a8AaF04Ef63708789189b8beD47AA338A';
            const CONTRACT_ABI = [
                "event CalcInt(address indexed user, string op, int256 a, int256 b, int256 result)",
                "event CalcFixed(address indexed user, string op, int256 a, int256 b, int256 result)",
                "function add(int256 a, int256 b) external returns (int256 r)",
                "function sub(int256 a, int256 b) external returns (int256 r)",
                "function mul(int256 a, int256 b) external returns (int256 r)",
                "function div(int256 a, int256 b) external returns (int256 r)",
                "function mod(int256 a, int256 b) external returns (int256 r)",
                "function iMin(int256 a, int256 b) external returns (int256 r)",
                "function iMax(int256 a, int256 b) external returns (int256 r)",
                "function iAvg(int256 a, int256 b) external returns (int256 r)",
                "function percent(int256 a, int256 pct) external returns (int256 r)",
                "function fAdd(int256 a, int256 b) external returns (int256 r)",
                "function fSub(int256 a, int256 b) external returns (int256 r)",
                "function fMul(int256 a, int256 b) external returns (int256 r)",
                "function fDiv(int256 a, int256 b) external returns (int256 r)",
            ];
            const SCALE = 1e18;

            // DOM elements
            const connectBtn = document.getElementById('connect-wallet-btn');
            const displayPrevious = document.getElementById('display-previous');
            const displayCurrent = document.getElementById('display-current');
            const allButtons = document.querySelectorAll('.btn');
            const calculateBtn = document.getElementById('calculate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const backspaceBtn = document.getElementById('backspace-btn');

            let provider, signer, contract, userAddress;
            let currentNumber = '0';
            let previousNumber = '';
            let operation = null;
            let waitingForNext = false;

            const operations = {
                add: "+", sub: "-", mul: "×", div: "÷", mod: "%",
                iMin: "min", iMax: "max", iAvg: "avg", percent: "%",
                fAdd: "+", fSub: "-", fMul: "×", fDiv: "÷",
            };

            // Helper to update the UI message
            const showMessage = (message, isError = false) => {
                // For this version, we will just log to the console
                console.log(isError ? "ERROR: " + message : "STATUS: " + message);
            };

            // Function to format fixed-point numbers
            const formatFixed = (value) => {
                if (!value) return "0";
                const num = Number(value) / SCALE;
                return num.toFixed(6).replace(/\.?0+$/, "");
            };

            // Function to handle wallet connection
            const connectWallet = async () => {
                if (typeof window.ethereum === 'undefined') {
                    showMessage("MetaMask is not installed. Please install it to use this app.", true);
                    return;
                }
                
                showMessage("Connecting to wallet...");
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    const accounts = await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    userAddress = accounts[0];
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    connectBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Connected</span>
                    `;
                    
                    // Set up event listeners for the contract
                    contract.on('CalcInt', (user, op, a, b, result) => {
                        if (user.toLowerCase() === userAddress.toLowerCase()) {
                            displayPrevious.textContent = `${a.toString()} ${operations[op]} ${b.toString()} =`;
                            displayCurrent.textContent = result.toString();
                            currentNumber = result.toString();
                            previousNumber = '';
                            operation = null;
                            waitingForNext = true;
                            showMessage(`Calculation confirmed: ${op}`);
                        }
                    });

                    contract.on('CalcFixed', (user, op, a, b, result) => {
                        if (user.toLowerCase() === userAddress.toLowerCase()) {
                            displayPrevious.textContent = `${formatFixed(a)} ${operations[op]} ${formatFixed(b)} =`;
                            displayCurrent.textContent = formatFixed(result);
                            currentNumber = formatFixed(result);
                            previousNumber = '';
                            operation = null;
                            waitingForNext = true;
                            showMessage(`Calculation confirmed: ${op}`);
                        }
                    });

                } catch (err) {
                    console.error("Failed to connect wallet:", err);
                    showMessage("Failed to connect wallet. " + err.message, true);
                }
            };

            // Function to handle number and operator clicks
            const handleButtonClick = async (event) => {
                const button = event.target;
                const value = button.dataset.val;
                const op = button.dataset.op;

                if (value) {
                    if (waitingForNext) {
                        currentNumber = value;
                        waitingForNext = false;
                        // NO LONGER CLEARING THE PREVIOUS DISPLAY HERE
                    } else if (currentNumber === '0' && value !== '.') {
                        currentNumber = value;
                    } else if (value === '.' && currentNumber.includes('.')) {
                        // Do nothing if a decimal is already present
                        return;
                    }
                    else {
                        currentNumber += value;
                    }
                } else if (op) {
                    if (previousNumber && operation) {
                        // If an operation is already pending, perform it first
                        await performCalculation();
                    }
                    previousNumber = currentNumber;
                    operation = op;
                    waitingForNext = true;
                    displayPrevious.textContent = `${previousNumber} ${operations[operation]}`;
                }

                displayCurrent.textContent = currentNumber;
            };

            // Function to handle equals button click
            const performCalculation = async () => {
                if (!contract) {
                    showMessage("Please connect your wallet first.", true);
                    return;
                }
                
                if (!previousNumber || !operation || !currentNumber) {
                    showMessage("Invalid calculation.", true);
                    return;
                }
                
                showMessage("Sending transaction...");

                try {
                    let tx;
                    if (["fAdd", "fSub", "fMul", "fDiv"].includes(operation)) {
                        const scaledA = ethers.parseUnits(previousNumber, 18);
                        const scaledB = ethers.parseUnits(currentNumber, 18);
                        tx = await contract[operation](scaledA, scaledB);
                    } else {
                        tx = await contract[operation](previousNumber, currentNumber);
                    }

                    await tx.wait(); // Wait for the transaction to be mined
                    showMessage("Transaction submitted. Waiting for result...");
                } catch (err) {
                    console.error("Calculation failed:", err);
                    let errorMessage = "Calculation failed. Check console for details.";
                    if (err.message.includes("revert")) {
                        errorMessage = "Transaction reverted. Check your inputs (e.g., division by zero).";
                    }
                    showMessage(errorMessage, true);
                }
            };

            // Function to clear the calculator state
            const clearCalculator = () => {
                currentNumber = '0';
                previousNumber = '';
                operation = null;
                waitingForNext = false;
                displayCurrent.textContent = '0';
                displayPrevious.textContent = '';
            };

            // Function to handle backspace
            const backspace = () => {
                if (currentNumber.length > 1) {
                    currentNumber = currentNumber.slice(0, -1);
                } else {
                    currentNumber = '0';
                }
                displayCurrent.textContent = currentNumber;
            };

            // Event listeners
            connectBtn.addEventListener('click', connectWallet);
            calculateBtn.addEventListener('click', performCalculation);
            clearBtn.addEventListener('click', clearCalculator);
            backspaceBtn.addEventListener('click', backspace);

            allButtons.forEach(button => {
                button.addEventListener('click', handleButtonClick);
            });
        })();
    </script>
</body>
</html>
